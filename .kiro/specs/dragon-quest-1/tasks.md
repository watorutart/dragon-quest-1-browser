# Implementation Plan

- [x] 1. プロジェクト基盤とテスト環境のセットアップ
  - HTML、CSS、JavaScriptの基本ファイル構造を作成
  - Jest テストフレームワークをセットアップ
  - Canvas要素とゲーム画面の基本レイアウトを実装
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [x] 2. Player クラスの TDD 実装
- [x] 2.1 Player クラスの基本ステータス管理をテスト駆動で実装
  - Player クラスの初期化テストを作成（Red）
  - Player クラスの基本実装（Green）
  - コードのリファクタリング（Refactor）
  - _Requirements: 3.1, 3.2, 3.3_

- [x] 2.2 Player の位置管理機能をテスト駆動で実装
  - 位置設定・取得のテストを作成（Red）
  - 位置管理メソッドの実装（Green）
  - 座標検証ロジックのリファクタリング（Refactor）
  - _Requirements: 1.1, 1.2_

- [x] 2.3 Player のレベルアップ機能をテスト駆動で実装
  - 経験値計算とレベルアップのテストを作成（Red）
  - レベルアップロジックの実装（Green）
  - ステータス計算式のリファクタリング（Refactor）
  - _Requirements: 3.1, 3.2, 3.3_

- [x] 3. Map システムの TDD 実装
- [x] 3.1 Map クラスの基本機能をテスト駆動で実装
  - マップデータ読み込みのテストを作成（Red）
  - Map クラスの基本実装（Green）
  - データ構造の最適化（Refactor）
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [x] 3.2 コリジョン検出システムをテスト駆動で実装
  - 移動可能性判定のテストを作成（Red）
  - コリジョン検出ロジックの実装（Green）
  - 判定アルゴリズムの最適化（Refactor）
  - _Requirements: 1.2, 1.3, 1.4_

- [x] 4. 移動システムの TDD 実装
- [x] 4.1 キーボード入力処理をテスト駆動で実装
  - 入力イベント処理のテストを作成（Red）
  - InputHandler クラスの実装（Green）
  - イベント処理の抽象化（Refactor）
  - _Requirements: 1.1_

- [x] 4.2 Player 移動ロジックをテスト駆動で実装
  - 移動処理のテストを作成（Red）
  - 移動メソッドの実装（Green）
  - 移動検証ロジックの統合（Refactor）
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [x] 5. 戦闘システムの TDD 実装
- [x] 5.1 Monster クラスをテスト駆動で実装
  - Monster の基本ステータスのテストを作成（Red）
  - Monster クラスの実装（Green）
  - Monster データ管理の最適化（Refactor）
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6_

- [x] 5.2 ダメージ計算システムをテスト駆動で実装
  - ダメージ計算のテストを作成（Red）
  - 戦闘ダメージロジックの実装（Green）
  - 計算式の調整とバランシング（Refactor）
  - _Requirements: 2.3, 2.5_

- [x] 5.3 戦闘状態管理をテスト駆動で実装
  - 戦闘開始・終了のテストを作成（Red）
  - BattleState クラスの実装（Green）
  - 状態遷移ロジックの整理（Refactor）
  - _Requirements: 2.1, 2.2, 2.6_

- [x] 5.4 逃走システムをテスト駆動で実装
  - 逃走成功率のテストを作成（Red）
  - 逃走判定ロジックの実装（Green）
  - 確率計算の調整（Refactor）
  - _Requirements: 2.4_

- [x] 6. ランダムエンカウントシステムの TDD 実装
- [x] 6.1 エンカウント判定をテスト駆動で実装
  - エンカウント発生のテストを作成（Red）
  - ランダムエンカウントロジックの実装（Green）
  - 確率調整とバランシング（Refactor）
  - _Requirements: 2.1_

- [x] 6.2 エンカウント後の状態遷移をテスト駆動で実装
  - フィールド→戦闘遷移のテストを作成（Red）
  - 状態遷移システムの実装（Green）
  - 遷移処理の抽象化（Refactor）
  - _Requirements: 2.1, 2.6_

- [x] 7. 描画システムの TDD 実装
- [x] 7.1 Canvas 描画エンジンをテスト駆動で実装
  - 基本描画機能のテストを作成（Red）
  - RenderEngine クラスの実装（Green）
  - 描画パフォーマンスの最適化（Refactor）
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [x] 7.2 スプライト描画システムをテスト駆動で実装
  - スプライト表示のテストを作成（Red）
  - スプライト描画ロジックの実装（Green）
  - 描画処理の効率化（Refactor）
  - _Requirements: 1.1, 2.1_

- [x] 8. NPC と対話システムの TDD 実装
- [x] 8.1 NPC クラスをテスト駆動で実装
  - NPC データ管理のテストを作成（Red）
  - NPC クラスの基本実装（Green）
  - NPC データ構造の最適化（Refactor）
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

- [x] 8.2 対話システムをテスト駆動で実装
  - 対話処理のテストを作成（Red）
  - DialogState クラスの実装（Green）
  - 対話フローの改善（Refactor）
  - _Requirements: 4.2, 4.3_

- [x] 9. アイテムとショップシステムの TDD 実装
- [x] 9.1 Item クラスをテスト駆動で実装
  - アイテムデータのテストを作成（Red）
  - Item クラスの実装（Green）
  - アイテム効果システムの整理（Refactor）
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5_

- [x] 9.2 装備システムをテスト駆動で実装
  - 装備変更のテストを作成（Red）
  - 装備管理ロジックの実装（Green）
  - ステータス反映システムの最適化（Refactor）
  - _Requirements: 5.2, 5.4_

- [x] 9.3 ショップシステムをテスト駆動で実装
  - 購入処理のテストを作成（Red）
  - Shop クラスの実装（Green）
  - 購入フローの改善（Refactor）
  - _Requirements: 5.1, 5.3, 5.5_

- [x] 10. ゲーム状態管理システムの TDD 実装
- [x] 10.1 StateManager をテスト駆動で実装
  - 状態遷移のテストを作成（Red）
  - StateManager クラスの実装（Green）
  - 状態管理の抽象化（Refactor）
  - _Requirements: 1.1, 2.1, 4.1, 4.4_

- [x] 10.2 FieldState をテスト駆動で実装
  - フィールド状態のテストを作成（Red）
  - FieldState クラスの実装（Green）
  - フィールドロジックの統合（Refactor）
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [x] 11. 最終ボス戦システムの TDD 実装
- [x] 11.1 竜王クラスをテスト駆動で実装
  - 竜王の特殊能力のテストを作成（Red）
  - 竜王クラスの実装（Green）
  - ボス戦バランスの調整（Refactor）
  - _Requirements: 6.1, 6.2_

- [x] 11.2 エンディングシステムをテスト駆動で実装
  - ゲームクリア処理のテストを作成（Red）
  - エンディング表示の実装（Green）
  - クリア統計の表示改善（Refactor）
  - _Requirements: 6.2, 6.3, 6.4_

- [x] 12. ブラウザ対応と動作確認
- [x] 12.1 モジュールシステムの修正
  - Node.js module.exports/require の条件分岐対応
  - ブラウザ環境での動作確認
  - スクリプト読み込み順序の最適化
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [x] 12.2 入力システムの統合
  - InputHandler の Map → オブジェクト変換
  - キーボード入力イベントの統合
  - テスト用移動システムの実装
  - _Requirements: 1.1_

- [x] 12.3 描画システムの統合
  - Canvas 描画エンジンの初期化
  - テスト用グリッド描画の実装
  - プレイヤー描画とリアルタイム更新
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [x] 13. 基本システムの修正とバグ修正
- [x] 13.1 モジュールエクスポートの修正
  - Map クラス名の修正（GameMap → Map）
  - ItemType 定数の定義と実装
  - BattleState クラスのエクスポート順序修正
  - _Requirements: 1.1, 2.1, 5.1_

- [x] 13.2 InputHandler クラスの実装
  - InputHandler クラスの基本実装
  - キーボードイベント処理の実装
  - コールバック機能の実装
  - _Requirements: 1.1_

- [x] 13.3 BattleState クラスの完全実装
  - BattleState クラスの基本構造実装
  - 戦闘ターン管理システムの実装
  - 戦闘コマンド処理の実装
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6_

- [ ] 14. ブラウザ環境での重複宣言エラー修正
- [ ] 14.1 依存性注入システムの修正
  - battleState.js の CombatSystem 重複宣言エラー修正
  - fieldState.js の InputHandler 重複宣言エラー修正
  - stateManager.js の Player 重複宣言エラー修正
  - _Requirements: 1.1, 2.1_

- [ ] 14.2 ブラウザ環境でのクラス参照修正
  - main.js での StateManager 未定義エラー修正
  - ブラウザ環境でのグローバルクラス参照の統一
  - スクリプト読み込み順序の最適化
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [ ] 15. 実際のゲームシステム統合
- [ ] 15.1 実際のマップデータとの統合
  - テスト描画から実際のマップデータ表示への切り替え
  - タイルベースマップの表示実装
  - プレイヤーキャラクターの正式な描画
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [ ] 15.2 エンカウントシステムの有効化
  - 移動時のエンカウント判定処理の統合
  - 戦闘画面への遷移実装
  - 戦闘終了後のフィールド復帰処理
  - _Requirements: 2.1, 2.6_

- [ ] 15.3 UI表示の完成
  - ステータス表示の正式実装
  - 戦闘UI、対話UI、ショップUIの統合
  - メニューシステムの実装
  - _Requirements: 3.3, 4.4, 5.5_

- [ ] 16. 最終調整とテスト
- [ ] 16.1 ゲームバランス調整
  - 戦闘バランスの最終調整
  - レベルアップ曲線の調整
  - アイテム価格・効果の調整
  - _Requirements: 2.3, 2.5, 5.1, 5.3_

- [ ] 16.2 エラーハンドリングと安定性
  - 異常系処理の強化
  - セーブ・ロード機能の実装（オプション）
  - パフォーマンス最適化
  - _Requirements: 全般_